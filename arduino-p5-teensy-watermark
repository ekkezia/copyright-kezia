// ==========================================================
// FINAL ARDUINO RECEIVER â€” FACE FLICKER + CONSTANT WATERMARK FLICKER, USE WITH p5js SKETCH
// ==========================================================

#include <OctoWS2811.h>

// --------------------------------------------
// LED CONFIGURATION
// --------------------------------------------
#define COLS    8
#define ROWS    32
#define STRIPS  3
#define NUM_LEDS (COLS * ROWS)

uint8_t pins[STRIPS] = {11, 9, 7};

DMAMEM uint32_t displayMemory[NUM_LEDS * STRIPS * 3 / 4];
uint32_t drawingMemory[NUM_LEDS * STRIPS * 3 / 4];
const int config = WS2811_GRB | WS2811_800kHz;

OctoWS2811 leds(NUM_LEDS, displayMemory, drawingMemory, config, STRIPS, pins);

// -----------------------------------------------------------
// INCOMING RGB BUFFER
// -----------------------------------------------------------
uint8_t rgbMap[ROWS][COLS][STRIPS][3];

// -----------------------------------------------------------
// NEW: DYNAMIC FACE MASK
// -----------------------------------------------------------
bool faceMask[ROWS][COLS][STRIPS];

// -----------------------------------------------------------
// NEW: CONSTANT WATERMARK MASK
// -----------------------------------------------------------
bool watermarkMask[ROWS][COLS][STRIPS];

// -----------------------------------------------------------
String incoming = "";

// -----------------------------------------------------------
// FLICKER STATE
// -----------------------------------------------------------
bool flickerState = false;
unsigned long lastFlicker = 0;
const unsigned long FLICKER_US = 1;

// --------------------------------------------
//  STATIC FLICKERED / WATERMARK PIXELS (row, col, strip)
// --------------------------------------------
const int FLICKERED_PIXELS[][3] = {
  // PATTERN: ANTI ALIASING
//  { 7, 5, 0 },
//   { 7, 1, 0 },
//   { 7, 6, 1 },
//   { 7, 3, 1 },
//   { 7, 2, 1 },
//   { 7, 1, 1 },
//   { 7, 0, 1 },
//   { 7, 7, 2 },
//   { 7, 4, 2 },
//   { 8, 6, 0 },
//   { 8, 4, 0 },
//   { 8, 1, 0 },
//   { 8, 0, 0 },
//   { 8, 6, 1 },
//   { 8, 1, 1 },
//   { 8, 4, 2 },
//   { 9, 6, 0 },
//   { 9, 4, 0 },
//   { 9, 1, 0 },
//   { 9, 7, 1 },
//   { 9, 6, 1 },
//   { 9, 1, 1 },
//   { 9, 4, 2 },
//   { 10, 6, 0 },
//   { 10, 5, 0 },
//   { 10, 4, 0 },
//   { 10, 1, 0 },
//   { 10, 6, 1 },
//   { 10, 1, 1 },
//   { 10, 4, 2 },
//   { 11, 6, 0 },
//   { 11, 4, 0 },
//   { 11, 1, 0 },
//   { 11, 6, 1 },
//   { 11, 1, 1 },
//   { 11, 4, 2 },
//   { 12, 6, 0 },
//   { 12, 4, 0 },
//   { 12, 1, 0 },
//   { 12, 6, 1 },
//   { 12, 1, 1 },
//   { 12, 4, 2 },
//   { 16, 5, 0 },
//   { 16, 1, 0 },
//   { 16, 5, 1 },
//   { 16, 1, 1 },
//   { 16, 4, 2 },
//   { 16, 3, 2 },
//   { 17, 6, 0 },
//   { 17, 4, 0 },
//   { 17, 1, 0 },
//   { 17, 5, 1 },
//   { 17, 2, 1 },
//   { 17, 0, 1 },
//   { 17, 5, 2 },
//   { 18, 6, 0 },
//   { 18, 4, 0 },
//   { 18, 1, 0 },
//   { 18, 5, 1 },
//   { 18, 2, 1 },
//   { 18, 0, 1 },
//   { 18, 4, 2 },
//   { 18, 3, 2 },
//   { 19, 6, 0 },
//   { 19, 5, 0 },
//   { 19, 4, 0 },
//   { 19, 1, 0 },
//   { 19, 5, 1 },
//   { 19, 2, 1 },
//   { 19, 1, 1 },
//   { 19, 0, 1 },
//   { 19, 2, 2 },
//   { 20, 6, 0 },
//   { 20, 4, 0 },
//   { 20, 1, 0 },
//   { 20, 5, 1 },
//   { 20, 2, 1 },
//   { 20, 0, 1 },
//   { 20, 5, 2 },
//   { 20, 2, 2 },
//   { 21, 6, 0 },
//   { 21, 4, 0 },
//   { 21, 1, 0 },
//   { 21, 0, 0 },
//   { 21, 7, 1 },
//   { 21, 5, 1 },
//   { 21, 2, 1 },
//   { 21, 0, 1 },
//   { 21, 4, 2 },
//   { 21, 3, 2 }
  // PATTERN: COPYRIGHT
  // { 6, 4, 0 },
  // { 6, 5, 1 },
  // { 6, 1, 1 },
  // { 6, 0, 1 },
  // { 6, 7, 2 },
  // { 6, 5, 2 },
  // { 6, 1, 2 },
  // { 7, 5, 0 },
  // { 7, 3, 0 },
  // { 7, 6, 1 },
  // { 7, 4, 1 },
  // { 7, 1, 1 },
  // { 7, 7, 2 },
  // { 7, 4, 2 },
  // { 7, 2, 2 },
  // { 8, 6, 0 },
  // { 8, 2, 0 },
  // { 8, 7, 1 },
  // { 8, 3, 1 },
  // { 8, 1, 1 },
  // { 8, 7, 2 },
  // { 8, 4, 2 },
  // { 8, 2, 2 },
  // { 9, 6, 0 },
  // { 9, 7, 1 },
  // { 9, 3, 1 },
  // { 9, 1, 1 },
  // { 9, 0, 1 },
  // { 9, 3, 2 },
  // { 10, 6, 0 },
  // { 10, 7, 1 },
  // { 10, 3, 1 },
  // { 10, 1, 1 },
  // { 10, 3, 2 },
  // { 11, 6, 0 },
  // { 11, 2, 0 },
  // { 11, 7, 1 },
  // { 11, 3, 1 },
  // { 11, 1, 1 },
  // { 11, 3, 2 },
  // { 12, 5, 0 },
  // { 12, 3, 0 },
  // { 12, 6, 1 },
  // { 12, 4, 1 },
  // { 12, 1, 1 },
  // { 12, 3, 2 },
  // { 13, 4, 0 },
  // { 13, 5, 1 },
  // { 13, 1, 1 },
  // { 13, 3, 2 },
  // { 17, 6, 0 },
  // { 17, 5, 0 },
  // { 17, 4, 0 },
  // { 17, 1, 0 },
  // { 17, 6, 1 },
  // { 17, 5, 1 },
  // { 17, 2, 1 },
  // { 17, 7, 2 },
  // { 17, 5, 2 },
  // { 17, 4, 2 },
  // { 17, 3, 2 },
  // { 17, 2, 2 },
  // { 17, 1, 2 },
  // { 18, 6, 0 },
  // { 18, 3, 0 },
  // { 18, 1, 0 },
  // { 18, 7, 1 },
  // { 18, 4, 1 },
  // { 18, 2, 1 },
  // { 18, 7, 2 },
  // { 18, 3, 2 },
  // { 19, 6, 0 },
  // { 19, 4, 0 },
  // { 19, 1, 0 },
  // { 19, 7, 1 },
  // { 19, 2, 1 },
  // { 19, 7, 2 },
  // { 19, 3, 2 },
  // { 20, 6, 0 },
  // { 20, 5, 0 },
  // { 20, 1, 0 },
  // { 20, 7, 1 },
  // { 20, 5, 1 },
  // { 20, 4, 1 },
  // { 20, 2, 1 },
  // { 20, 1, 1 },
  // { 20, 0, 1 },
  // { 20, 7, 2 },
  // { 20, 3, 2 },
  // { 21, 6, 0 },
  // { 21, 4, 0 },
  // { 21, 1, 0 },
  // { 21, 7, 1 },
  // { 21, 4, 1 },
  // { 21, 2, 1 },
  // { 21, 7, 2 },
  // { 21, 3, 2 },
  // { 22, 6, 0 },
  // { 22, 4, 0 },
  // { 22, 1, 0 },
  // { 22, 7, 1 },
  // { 22, 4, 1 },
  // { 22, 2, 1 },
  // { 22, 7, 2 },
  // { 22, 3, 2 },
  // { 23, 6, 0 },
  // { 23, 3, 0 },
  // { 23, 1, 0 },
  // { 23, 6, 1 },
  // { 23, 5, 1 },
  // { 23, 2, 1 },
  // { 23, 7, 2 },
  // { 23, 3, 2 },
  // PATTERN: ekezia
    {1,3,0},{1,2,0},{1,1,0},{2,4,0},{2,3,0},{2,0,0},
  {3,5,0},{3,3,0},{3,0,0},{4,5,0},{4,2,0},{4,1,0},
  {5,4,0},{5,6,1},{6,7,1},{7,1,0},{7,0,0},{7,7,1},
  {8,2,0},{8,0,0},{8,6,1},{9,3,0},{9,0,0},{9,5,1},
  {10,0,0},{11,0,0},{11,5,1},{11,4,1},{11,3,1},
  {12,6,1},{12,5,1},{12,2,1},{13,7,1},{13,4,1},
  {13,2,1},{14,7,1},{14,3,1},{15,6,1},{15,0,1},
  {16,7,2},{17,5,1},{17,4,1},{17,3,1},{17,2,1},
  {17,1,1},{17,0,1},{17,7,2},{18,4,1},{19,4,1},
  {19,4,2},{20,3,1},{20,6,2},{21,0,1},{21,7,2},
  {22,2,1},{22,1,1},{23,3,1},{23,1,2},{24,6,2},
  {24,5,2},{24,4,2},{24,3,2},{24,0,2},{25,6,2},
  {25,3,2},{25,1,2},{26,6,2},{26,3,2},{26,2,2},
  {27,5,2},{27,4,2},{27,3,2},{28,4,2},{29,4,2}
  // PATTERN: QR
  //   { 4, 7, 0 },   { 4, 6, 0 },   { 4, 5, 0 },   { 4, 4, 0 },   { 4, 3, 0 },   { 4, 2, 0 },   { 4, 0, 0 },   { 4, 6, 1 },
  // { 4, 3, 1 },   { 4, 2, 1 },   { 4, 7, 2 },   { 4, 5, 2 },   { 4, 4, 2 },   { 4, 3, 2 },   { 4, 2, 2 },   { 4, 1, 2 },
  // { 4, 0, 2 },   { 5, 7, 0 },   { 5, 2, 0 },   { 5, 0, 0 },   { 5, 7, 1 },   { 5, 4, 1 },   { 5, 3, 1 },   { 5, 0, 1 },
  // { 5, 5, 2 },   { 5, 0, 2 },   { 6, 7, 0 },   { 6, 5, 0 },   { 6, 4, 0 },   { 6, 2, 0 },   { 6, 7, 1 },   { 6, 4, 1 },
  // { 6, 2, 1 },   { 6, 1, 1 },   { 6, 7, 2 },   { 6, 5, 2 },   { 6, 3, 2 },   { 6, 2, 2 },   { 6, 0, 2 },   { 7, 7, 0 },
  // { 7, 5, 0 },   { 7, 4, 0 },   { 7, 2, 0 },   { 7, 6, 1 },   { 7, 4, 1 },   { 7, 2, 1 },   { 7, 0, 1 },   { 7, 5, 2 },
  // { 7, 3, 2 },   { 7, 2, 2 },   { 7, 0, 2 },   { 8, 7, 0 },   { 8, 2, 0 },   { 8, 0, 0 },   { 8, 5, 1 },   { 8, 2, 1 },
  // { 8, 1, 1 },   { 8, 0, 1 },   { 8, 5, 2 },   { 8, 0, 2 },   { 9, 7, 0 },   { 9, 6, 0 },   { 9, 5, 0 },   { 9, 4, 0 },
  // { 9, 3, 0 },   { 9, 2, 0 },   { 9, 7, 1 },   { 9, 5, 1 },   { 9, 2, 1 },   { 9, 0, 1 },   { 9, 5, 2 },   { 9, 4, 2 },
  // { 9, 3, 2 },   { 9, 2, 2 },   { 9, 1, 2 },   { 9, 0, 2 },   { 10, 0, 0 },   { 10, 5, 1 },   { 10, 4, 1 },   { 10, 3, 1 },
  // { 10, 1, 1 },   { 10, 7, 2 },   { 11, 6, 0 },   { 11, 5, 0 },   { 11, 4, 0 },   { 11, 3, 0 },   { 11, 0, 0 },   { 11, 7, 1 },
  // { 11, 5, 1 },   { 11, 4, 1 },   { 11, 1, 1 },   { 11, 5, 2 },   { 11, 4, 2 },   { 11, 1, 2 },   { 11, 0, 2 },   { 12, 2, 0 },
  // { 12, 0, 0 },   { 12, 7, 1 },   { 12, 2, 1 },   { 12, 4, 2 },   { 12, 2, 2 },   { 12, 0, 2 },   { 13, 7, 0 },   { 13, 1, 0 },
  // { 13, 7, 1 },   { 13, 3, 1 },   { 13, 7, 2 },   { 13, 6, 2 },   { 13, 5, 2 },   { 13, 4, 2 },   { 13, 3, 2 },   { 14, 7, 0 },
  // { 14, 6, 0 },   { 14, 5, 0 },   { 14, 4, 0 },   { 14, 3, 0 },   { 14, 2, 0 },   { 14, 0, 0 },   { 14, 7, 1 },   { 14, 2, 1 },
  // { 14, 0, 1 },   { 14, 7, 2 },   { 14, 5, 2 },   { 14, 4, 2 },   { 14, 3, 2 },   { 14, 2, 2 },   { 14, 0, 2 },   { 15, 7, 0 },
  // { 15, 2, 0 },   { 15, 0, 0 },   { 15, 6, 1 },   { 15, 5, 1 },   { 15, 4, 1 },   { 15, 2, 1 },   { 15, 7, 2 },   { 15, 6, 2 },
  // { 15, 5, 2 },   { 15, 4, 2 },   { 15, 3, 2 },   { 15, 1, 2 },   { 16, 6, 0 },   { 16, 4, 0 },   { 16, 3, 0 },   { 16, 0, 0 },
  // { 16, 7, 1 },   { 16, 5, 1 },   { 16, 2, 1 },   { 16, 1, 1 },   { 16, 0, 1 },   { 16, 7, 2 },   { 16, 2, 2 },   { 17, 7, 0 },
  // { 17, 6, 0 },   { 17, 5, 0 },   { 17, 4, 0 },   { 17, 3, 0 },   { 17, 2, 0 },   { 17, 0, 0 },   { 17, 7, 1 },   { 17, 5, 1 },
  // { 17, 3, 1 },   { 17, 2, 1 },   { 17, 0, 1 },   { 17, 7, 2 },   { 17, 6, 2 },   { 17, 5, 2 },   { 17, 4, 2 },   { 17, 2, 2 },
  // { 17, 1, 2 },   { 17, 0, 2 },   { 18, 7, 0 },   { 18, 5, 0 },   { 18, 4, 0 },   { 18, 2, 0 },   { 18, 7, 1 },   { 18, 4, 1 },
  // { 18, 3, 1 },   { 18, 1, 1 },   { 18, 7, 2 },   { 18, 6, 2 },   { 18, 5, 2 },   { 18, 4, 2 },   { 18, 3, 2 },   { 18, 1, 2 },
  // { 19, 7, 0 },   { 19, 6, 0 },   { 19, 5, 0 },   { 19, 4, 0 },   { 19, 3, 0 },   { 19, 2, 0 },   { 19, 0, 0 },   { 19, 6, 1 },
  // { 19, 5, 1 },   { 19, 4, 1 },   { 19, 2, 1 },   { 19, 7, 2 },   { 19, 3, 2 },   { 19, 2, 2 },   { 19, 0, 2 },   { 20, 7, 0 },
  // { 20, 6, 0 },   { 20, 5, 0 },   { 20, 3, 0 },   { 20, 1, 0 },   { 20, 0, 0 },   { 20, 7, 1 },   { 20, 6, 1 },   { 20, 5, 1 },
  // { 20, 4, 1 },   { 20, 3, 1 },   { 20, 2, 1 },   { 20, 0, 1 },   { 20, 7, 2 },   { 20, 6, 2 },   { 20, 5, 2 },   { 20, 1, 2 },
  // { 21, 0, 0 },   { 21, 3, 1 },   { 21, 2, 1 },   { 21, 1, 1 },   { 21, 3, 2 },   { 21, 1, 2 },   { 21, 0, 2 },   { 22, 7, 0 },
  // { 22, 6, 0 },   { 22, 5, 0 },   { 22, 4, 0 },   { 22, 3, 0 },   { 22, 2, 0 },   { 22, 7, 1 },   { 22, 6, 1 },   { 22, 5, 1 },
  // { 22, 4, 1 },   { 22, 3, 1 },   { 22, 5, 2 },   { 22, 3, 2 },   { 22, 2, 2 },   { 22, 0, 2 },   { 23, 7, 0 },   { 23, 2, 0 },
  // { 23, 0, 0 },   { 23, 7, 1 },   { 23, 4, 1 },   { 23, 3, 1 },   { 23, 1, 1 },   { 23, 7, 2 },   { 23, 3, 2 },   { 23, 1, 2 },
  // { 24, 7, 0 },   { 24, 5, 0 },   { 24, 4, 0 },   { 24, 2, 0 },   { 24, 0, 0 },   { 24, 7, 1 },   { 24, 6, 1 },   { 24, 4, 1 },
  // { 24, 1, 1 },   { 24, 7, 2 },   { 24, 6, 2 },   { 24, 5, 2 },   { 24, 4, 2 },   { 24, 3, 2 },   { 24, 1, 2 },   { 25, 7, 0 },
  // { 25, 5, 0 },   { 25, 4, 0 },   { 25, 2, 0 },   { 25, 5, 1 },   { 25, 4, 1 },   { 25, 3, 1 },   { 25, 1, 1 },   { 25, 0, 1 },
  // { 25, 6, 2 },   { 25, 4, 2 },   { 25, 3, 2 },   { 25, 2, 2 },   { 25, 1, 2 },   { 25, 0, 2 },   { 26, 7, 0 },   { 26, 2, 0 },
  // { 26, 0, 0 },   { 26, 5, 1 },   { 26, 0, 1 },   { 27, 7, 0 },   { 27, 6, 0 },   { 27, 5, 0 },   { 27, 4, 0 },   { 27, 3, 0 },
  // { 27, 2, 0 },   { 27, 0, 0 },   { 27, 7, 1 },   { 27, 6, 1 },   { 27, 5, 1 },   { 27, 3, 1 },   { 27, 2, 1 },   { 27, 6, 2 },
  // { 27, 4, 2 },   { 27, 3, 2 },   { 27, 0, 2 }
};
const int FLICKERED_COUNT = sizeof(FLICKERED_PIXELS) / sizeof(FLICKERED_PIXELS[0]);

// ===========================================================
// CLEAR FACE MASK
// ===========================================================
void clearFaceMask() {
  for (int r = 0; r < ROWS; r++)
    for (int c = 0; c < COLS; c++)
      for (int s = 0; s < STRIPS; s++)
        faceMask[r][c][s] = false;
}

// ===========================================================
// BUILD WATERMARK MASK (STATIC)
// ===========================================================
void initWatermarkMask() {
  for (int r = 0; r < ROWS; r++)
    for (int c = 0; c < COLS; c++)
      for (int s = 0; s < STRIPS; s++)
        watermarkMask[r][c][s] = false;

  for (int i = 0; i < FLICKERED_COUNT; i++) {
    int row   = FLICKERED_PIXELS[i][0];
    int col   = FLICKERED_PIXELS[i][1];
    int strip = FLICKERED_PIXELS[i][2];

    if (row >= 0 && row < ROWS &&
        col >= 0 && col < COLS &&
        strip >= 0 && strip < STRIPS)
    {
      watermarkMask[row][col][strip] = true;
    }
  }
}


// ===========================================================
// HANDLE "FACE: row,col,strip;row,col,strip;..."
// ===========================================================
void parseFaceMask(String payload) {
  if (!payload.startsWith("FACE:")) return;

  payload.remove(0, 5);
  clearFaceMask();

  size_t idx = 0;
  size_t len = payload.length();

  while (idx < len) {
    size_t nextComma = payload.indexOf(',', idx);
    if (nextComma == (size_t)-1) break;
    int row = payload.substring(idx, nextComma).toInt();
    idx = nextComma + 1;

    nextComma = payload.indexOf(',', idx);
    if (nextComma == (size_t)-1) break;
    int col = payload.substring(idx, nextComma).toInt();
    idx = nextComma + 1;

    size_t nextSemi = payload.indexOf(';', idx);
    if (nextSemi == (size_t)-1) break;
    int strip = payload.substring(idx, nextSemi).toInt();
    idx = nextSemi + 1;

    if (row >= 0 && row < ROWS &&
        col >= 0 && col < COLS &&
        strip >= 0 && strip < STRIPS)
    {
      faceMask[row][col][strip] = true;
    }
  }

  Serial.println("FACE MASK UPDATED");
}


// ===========================================================
// PARSE CAMERA RGB FRAME
// ===========================================================
void parseFrame() {
  int field = 0;
  int row, col, strip;
  int r, g, b;

  int last = 0;
  int len = incoming.length();

  for (int i = 0; i <= len; i++) {
    if (i == len || incoming[i] == ',') {

      int v = incoming.substring(last, i).toInt();

      switch (field) {
        case 0: row   = v; break;
        case 1: col   = v; break;
        case 2: strip = v; break;
        case 3: r     = v; break;
        case 4: g     = v; break;
        case 5: b     = v; break;
      }

      field++;

      if (field == 6) {
        rgbMap[row][col][strip][0] = r;
        rgbMap[row][col][strip][1] = g;
        rgbMap[row][col][strip][2] = b;
        field = 0;
      }

      last = i + 1;
    }
  }

  Serial.println("FRAME OK");
}


// ===========================================================
// MATRIX ADDRESSING
// ===========================================================
int XY(int col, int row) {
  return (row % 2 == 0)
    ? row * COLS + col
    : row * COLS + (COLS - 1 - col);
}

inline void setPixelRGB(int strip, int idx, uint8_t r, uint8_t g, uint8_t b) {
  int global = strip * NUM_LEDS + idx;
  leds.setPixel(global, (r << 16) | (g << 8) | b);
}


// ===========================================================
// DRAW EVERYTHING WITH FLICKER
// ===========================================================
void drawAll() {

  for (int strip = 0; strip < STRIPS; strip++) {
    for (int col = 0; col < COLS; col++) {
      for (int row = 0; row < ROWS; row++) {

        uint8_t r = rgbMap[row][col][strip][0];
        uint8_t g = rgbMap[row][col][strip][1];
        uint8_t b = rgbMap[row][col][strip][2];

        // NEW: merged flicker source
        bool flick =
            faceMask[row][col][strip] ||
            watermarkMask[row][col][strip];

        // physical LED index
        int physRow   = ROWS - 1 - row;
        int physCol   = COLS - 1 - col;
        int physStrip = STRIPS - 1 - strip;
        int idx = XY(physCol, physRow);

        // APPLY FLICKER
        if (flick) {
          // For flickering by odd-even columns
          // bool phase = (row + col) & 1;
          // bool state = flickerState ^ phase;

          // if (state)
          //   setPixelRGB(physStrip, idx, r, g, b);
          // else
          //   setPixelRGB(physStrip, idx, 0, 0, 0);

          // For flickering all together at the same time
          if (flickerState) {
              setPixelRGB(physStrip, idx, r, g, b);   // show original RGB
            } else {
              setPixelRGB(physStrip, idx, 0, 0, 0);   // turn off
            }
        }
        else {
          setPixelRGB(physStrip, idx, r, g, b);
        }
      }
    }
  }
}


// ===========================================================
// SETUP
// ===========================================================
void setup() {
  Serial.begin(115200);
  leds.begin();
  leds.show();

  clearFaceMask();
  initWatermarkMask();  // NEW
  Serial.println("READY");
}


// ===========================================================
// LOOP
// ===========================================================
void loop() {
  // flicker timing
  unsigned long now = micros();
  if (now - lastFlicker >= FLICKER_US) {
    flickerState = !flickerState;
    lastFlicker = now;
  }

  // serial read
  while (Serial.available()) {
    char c = Serial.read();

    if (c == '\n') {
      if (incoming.startsWith("FACE:"))
        parseFaceMask(incoming);
      else
        parseFrame();

      incoming = "";
    } else {
      incoming += c;
    }
  }

  drawAll();
  leds.show();
}
